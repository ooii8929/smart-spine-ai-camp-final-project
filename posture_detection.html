<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åå§¿åµæ¸¬ç³»çµ± - Posture Detection</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 1400px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            padding: 30px;
        }

        .video-section {
            position: relative;
        }

        .video-container {
            position: relative;
            width: 100%;
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        #videoElement {
            width: 100%;
            display: block;
            transform: scaleX(-1);
        }

        #canvasElement {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }

        .status-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.correct {
            background: #4ade80;
            box-shadow: 0 0 10px #4ade80;
        }

        .status-indicator.incorrect {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .info-card {
            background: #f8fafc;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .info-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #64748b;
            font-size: 0.95em;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
            color: #1e293b;
        }

        .posture-status {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .posture-status.correct {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
        }

        .posture-status.incorrect {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .posture-status h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .posture-status p {
            font-size: 1em;
            opacity: 0.9;
        }

        .suggestion-box {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .suggestion-box h4 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .suggestion-box ul {
            list-style: none;
            padding: 0;
        }

        .suggestion-box li {
            color: #78350f;
            padding: 5px 0;
            font-size: 0.9em;
        }

        .suggestion-box li:before {
            content: "â†’ ";
            font-weight: bold;
            margin-right: 5px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }

        .btn-secondary:hover {
            background: #cbd5e1;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .loading-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.85em;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }
        }

        .setting-item {
            margin: 15px 0;
        }

        .setting-item label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #475569;
            font-size: 0.9em;
        }

        .setting-item input[type="range"] {
            width: 100%;
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        .setting-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .setting-item input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: #667eea;
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª‘ æ™ºèƒ½åå§¿åµæ¸¬ç³»çµ±</h1>
            <p>Intelligent Posture Detection System</p>
        </div>

        <div class="main-content">
            <div class="video-section">
                <div class="video-container">
                    <video id="videoElement" autoplay playsinline></video>
                    <canvas id="canvasElement"></canvas>
                    <div class="status-overlay">
                        <div class="status-indicator correct" id="statusIndicator"></div>
                        <span id="statusText">æ­£åœ¨åˆå§‹åŒ–...</span>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="startBtn">é–‹å§‹åµæ¸¬</button>
                    <button class="btn btn-secondary" id="resetBtn">é‡ç½®çµ±è¨ˆ</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="posture-status correct" id="postureStatus">
                    <h2>ğŸ˜Š å§¿å‹¢æ­£ç¢º</h2>
                    <p>ä¿æŒè‰¯å¥½åå§¿ï¼</p>
                </div>

                <!-- æ–°å¢ï¼šåƒæ•¸è¨­å®šé¢æ¿ -->
                <div class="info-card">
                    <h3>âš™ï¸ éˆæ•åº¦è¨­å®š</h3>
                    <div class="setting-item">
                        <label for="shoulderSensitivity">è‚©è†€å®¹è¨±è§’åº¦: <span id="shoulderValue">15Â°</span></label>
                        <input type="range" id="shoulderSensitivity" min="5" max="30" value="15" step="1">
                    </div>
                    <div class="setting-item">
                        <label for="backMinSensitivity">èƒŒéƒ¨æœ€å°è§’åº¦: <span id="backMinValue">60Â°</span></label>
                        <input type="range" id="backMinSensitivity" min="45" max="75" value="60" step="5">
                    </div>
                    <div class="setting-item">
                        <label for="backMaxSensitivity">èƒŒéƒ¨æœ€å¤§è§’åº¦: <span id="backMaxValue">120Â°</span></label>
                        <input type="range" id="backMaxSensitivity" min="105" max="135" value="120" step="5">
                    </div>
                    <div class="setting-item">
                        <label for="headSensitivity">é ­éƒ¨å‰å‚¾å®¹è¨±: <span id="headValue">45%</span></label>
                        <input type="range" id="headSensitivity" min="20" max="60" value="45" step="5">
                    </div>
                    <button class="btn btn-secondary" id="resetSettingsBtn" style="width: 100%; margin-top: 10px;">é‡ç½®ç‚ºé è¨­å€¼</button>
                </div>

                <div class="info-card">
                    <h3>ğŸ“Š å³æ™‚æ•¸æ“š</h3>
                    <div class="metric">
                        <span class="metric-label">è‚©è†€æ°´å¹³åº¦</span>
                        <span class="metric-value" id="shoulderAngle">--Â°</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">èƒŒéƒ¨è§’åº¦</span>
                        <span class="metric-value" id="backAngle">--Â°</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">é ­éƒ¨å‰å‚¾</span>
                        <span class="metric-value" id="headForward">--Â°</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">åµæ¸¬ä¿¡å¿ƒåº¦</span>
                        <span class="metric-value" id="confidence">--</span>
                    </div>
                </div>

                <div class="info-card">
                    <h3>ğŸ“ˆ ä½¿ç”¨çµ±è¨ˆ</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <span class="stat-number" id="totalTime">0</span>
                            <span class="stat-label">ç¸½æ™‚é–“(ç§’)</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-number" id="correctTime">0</span>
                            <span class="stat-label">æ­£ç¢º(ç§’)</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-number" id="incorrectTime">0</span>
                            <span class="stat-label">éŒ¯èª¤(ç§’)</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-number" id="accuracy">0%</span>
                            <span class="stat-label">æ­£ç¢ºç‡</span>
                        </div>
                    </div>
                </div>

                <div class="suggestion-box" id="suggestionBox">
                    <h4>ğŸ’¡ æ”¹å–„å»ºè­°</h4>
                    <ul id="suggestionList">
                        <li>ç­‰å¾…é–‹å§‹åµæ¸¬...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let pose = null;
        let camera = null;
        let isDetecting = false;
        let currentPosture = { isCorrect: true, issues: [] };
        
        // å¯èª¿æ•´çš„åˆ¤æ–·æ¨™æº–ï¼ˆæ›´å¯¬é¬†çš„é è¨­å€¼ï¼‰
        let thresholds = {
            shoulderAngle: 15,      // è‚©è†€è§’åº¦å®¹è¨±å€¼ï¼ˆåŸæœ¬ 10ï¼‰
            backAngleMin: 60,       // èƒŒéƒ¨æœ€å°è§’åº¦ï¼ˆåŸæœ¬ 75ï¼‰
            backAngleMax: 120,      // èƒŒéƒ¨æœ€å¤§è§’åº¦ï¼ˆåŸæœ¬ 105ï¼‰
            headForward: 0.45       // é ­éƒ¨å‰å‚¾å®¹è¨±å€¼ï¼ˆåŸæœ¬ 0.3ï¼‰
        };
        
        // çµ±è¨ˆæ•¸æ“š
        let stats = {
            totalTime: 0,
            correctTime: 0,
            incorrectTime: 0,
            lastUpdateTime: Date.now()
        };

        // DOM å…ƒç´ 
        const videoElement = document.getElementById('videoElement');
        const canvasElement = document.getElementById('canvasElement');
        const canvasCtx = canvasElement.getContext('2d');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const postureStatus = document.getElementById('postureStatus');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');

        // è¨ˆç®—å…©é»ä¹‹é–“çš„è·é›¢
        function calculateDistance(point1, point2) {
            const dx = point1.x - point2.x;
            const dy = point1.y - point2.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        // è¨ˆç®—è§’åº¦ï¼ˆåº¦æ•¸ï¼‰
        function calculateAngle(point1, point2, point3) {
            const vector1 = { x: point1.x - point2.x, y: point1.y - point2.y };
            const vector2 = { x: point3.x - point2.x, y: point3.y - point2.y };
            
            const dot = vector1.x * vector2.x + vector1.y * vector2.y;
            const mag1 = Math.sqrt(vector1.x * vector1.x + vector1.y * vector1.y);
            const mag2 = Math.sqrt(vector2.x * vector2.x + vector2.y * vector2.y);
            
            const angleRad = Math.acos(dot / (mag1 * mag2));
            return (angleRad * 180) / Math.PI;
        }

        // åˆ†æåå§¿
        function analyzePosture(landmarks) {
            const issues = [];
            let angles = {
                shoulder: 0,
                back: 90,
                headForward: 0
            };

            // é—œéµé»ç´¢å¼•
            const nose = landmarks[0];
            const leftShoulder = landmarks[11];
            const rightShoulder = landmarks[12];
            const leftHip = landmarks[23];
            const rightHip = landmarks[24];

            // 1. æª¢æŸ¥è‚©è†€æ°´å¹³åº¦
            if (leftShoulder && rightShoulder) {
                const shoulderDiff = Math.abs(leftShoulder.y - rightShoulder.y);
                angles.shoulder = Math.atan(shoulderDiff / Math.abs(leftShoulder.x - rightShoulder.x)) * 180 / Math.PI;
                
                if (angles.shoulder > thresholds.shoulderAngle) {
                    issues.push('è‚©è†€ä¸å¹³è¡¡ï¼Œè«‹èª¿æ•´åå§¿');
                }
            }

            // 2. æª¢æŸ¥èƒŒéƒ¨è§’åº¦ï¼ˆè‚©è†€åˆ°è‡€éƒ¨ï¼‰
            if (leftShoulder && rightShoulder && leftHip && rightHip) {
                const shoulderMid = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };
                const hipMid = {
                    x: (leftHip.x + rightHip.x) / 2,
                    y: (leftHip.y + rightHip.y) / 2
                };

                // è¨ˆç®—èƒŒéƒ¨èˆ‡å‚ç›´ç·šçš„è§’åº¦
                const backAngleRad = Math.atan2(shoulderMid.x - hipMid.x, hipMid.y - shoulderMid.y);
                angles.back = Math.abs(backAngleRad * 180 / Math.PI);

                if (angles.back < thresholds.backAngleMin || angles.back > thresholds.backAngleMax) {
                    if (angles.back < thresholds.backAngleMin) {
                        issues.push('èº«é«”å‰å‚¾éå¤šï¼Œè«‹åç›´');
                    } else {
                        issues.push('èº«é«”å¾Œä»°éå¤šï¼Œè«‹èª¿æ•´åå§¿');
                    }
                }
            }

            // 3. æª¢æŸ¥é ­éƒ¨å‰å‚¾
            if (nose && leftShoulder && rightShoulder) {
                const shoulderMid = {
                    x: (leftShoulder.x + rightShoulder.x) / 2,
                    y: (leftShoulder.y + rightShoulder.y) / 2
                };

                const headForwardDist = Math.abs(nose.x - shoulderMid.x);
                const shoulderWidth = calculateDistance(leftShoulder, rightShoulder);
                const headForwardRatio = headForwardDist / shoulderWidth;
                angles.headForward = headForwardRatio * 100;

                if (headForwardRatio > thresholds.headForward) {
                    issues.push('é ­éƒ¨å‰å‚¾éå¤šï¼Œè«‹å°‡é ­éƒ¨å¾€å¾Œç§»');
                }
            }

            // æ›´æ–° UI æ•¸å€¼
            document.getElementById('shoulderAngle').textContent = angles.shoulder.toFixed(1) + 'Â°';
            document.getElementById('backAngle').textContent = angles.back.toFixed(1) + 'Â°';
            document.getElementById('headForward').textContent = angles.headForward.toFixed(1) + 'Â°';

            return {
                isCorrect: issues.length === 0,
                issues: issues,
                angles: angles
            };
        }

        // ç¹ªè£½éª¨æ¶
        function drawSkeleton(landmarks) {
            // è¨­å®š Canvas å°ºå¯¸
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            // æ¸…é™¤ç•«å¸ƒ
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            // é€£æ¥ç·šå®šç¾©
            const connections = [
                [11, 12], // è‚©è†€
                [11, 13], [13, 15], // å·¦è‡‚
                [12, 14], [14, 16], // å³è‡‚
                [11, 23], [12, 24], // èº«é«”
                [23, 24], // è‡€éƒ¨
                [23, 25], [25, 27], // å·¦è…¿
                [24, 26], [26, 28], // å³è…¿
            ];

            // è¨­å®šé¡è‰²
            const color = currentPosture.isCorrect ? '#4ade80' : '#ef4444';

            // ç¹ªè£½é€£æ¥ç·š
            canvasCtx.strokeStyle = color;
            canvasCtx.lineWidth = 3;
            connections.forEach(([start, end]) => {
                const startPoint = landmarks[start];
                const endPoint = landmarks[end];
                if (startPoint && endPoint) {
                    canvasCtx.beginPath();
                    canvasCtx.moveTo(startPoint.x * canvasElement.width, startPoint.y * canvasElement.height);
                    canvasCtx.lineTo(endPoint.x * canvasElement.width, endPoint.y * canvasElement.height);
                    canvasCtx.stroke();
                }
            });

            // ç¹ªè£½é—œéµé»
            canvasCtx.fillStyle = color;
            landmarks.forEach((landmark, index) => {
                if (landmark && landmark.visibility > 0.5) {
                    const x = landmark.x * canvasElement.width;
                    const y = landmark.y * canvasElement.height;
                    
                    // é‡è¦é—œéµé»ç•«å¤§ä¸€é»
                    const radius = [0, 11, 12, 23, 24].includes(index) ? 6 : 4;
                    
                    canvasCtx.beginPath();
                    canvasCtx.arc(x, y, radius, 0, 2 * Math.PI);
                    canvasCtx.fill();
                }
            });
        }

        // æ›´æ–°çµ±è¨ˆ
        function updateStats() {
            const now = Date.now();
            const elapsed = (now - stats.lastUpdateTime) / 1000;
            stats.lastUpdateTime = now;

            stats.totalTime += elapsed;
            if (currentPosture.isCorrect) {
                stats.correctTime += elapsed;
            } else {
                stats.incorrectTime += elapsed;
            }

            const accuracy = stats.totalTime > 0 
                ? ((stats.correctTime / stats.totalTime) * 100).toFixed(1) 
                : 0;

            document.getElementById('totalTime').textContent = Math.floor(stats.totalTime);
            document.getElementById('correctTime').textContent = Math.floor(stats.correctTime);
            document.getElementById('incorrectTime').textContent = Math.floor(stats.incorrectTime);
            document.getElementById('accuracy').textContent = accuracy + '%';
        }

        // æ›´æ–° UI
        function updateUI() {
            // æ›´æ–°ç‹€æ…‹æŒ‡ç¤ºå™¨
            if (currentPosture.isCorrect) {
                statusIndicator.className = 'status-indicator correct';
                statusText.textContent = 'å§¿å‹¢æ­£ç¢º âœ“';
                postureStatus.className = 'posture-status correct';
                postureStatus.innerHTML = '<h2>ğŸ˜Š å§¿å‹¢æ­£ç¢º</h2><p>ä¿æŒè‰¯å¥½åå§¿ï¼</p>';
            } else {
                statusIndicator.className = 'status-indicator incorrect';
                statusText.textContent = 'å§¿å‹¢éœ€è¦èª¿æ•´ âœ—';
                postureStatus.className = 'posture-status incorrect';
                postureStatus.innerHTML = '<h2>âš ï¸ å§¿å‹¢ä¸æ­£ç¢º</h2><p>è«‹æ³¨æ„ä¸‹æ–¹å»ºè­°</p>';
            }

            // æ›´æ–°å»ºè­°
            const suggestionList = document.getElementById('suggestionList');
            if (currentPosture.issues.length > 0) {
                suggestionList.innerHTML = currentPosture.issues
                    .map(issue => `<li>${issue}</li>`)
                    .join('');
            } else {
                suggestionList.innerHTML = '<li>å§¿å‹¢è‰¯å¥½ï¼Œç¹¼çºŒä¿æŒï¼</li>';
            }

            // æ›´æ–°çµ±è¨ˆ
            updateStats();
        }

        // MediaPipe çµæœè™•ç†
        function onResults(results) {
            if (!results.poseLandmarks) {
                return;
            }

            // æ›´æ–°ä¿¡å¿ƒåº¦
            const avgVisibility = results.poseLandmarks.reduce((sum, lm) => sum + (lm.visibility || 0), 0) / results.poseLandmarks.length;
            document.getElementById('confidence').textContent = (avgVisibility * 100).toFixed(0) + '%';

            // åˆ†æåå§¿
            currentPosture = analyzePosture(results.poseLandmarks);

            // ç¹ªè£½éª¨æ¶
            drawSkeleton(results.poseLandmarks);

            // æ›´æ–° UI
            updateUI();
        }

        // åˆå§‹åŒ–æ”å½±æ©Ÿ
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 1280, height: 720 }
                });
                videoElement.srcObject = stream;
                
                videoElement.onloadedmetadata = () => {
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                };

                return true;
            } catch (error) {
                console.error('ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:', error);
                statusText.textContent = 'æ”å½±æ©Ÿå­˜å–å¤±æ•—';
                return false;
            }
        }

        // åˆå§‹åŒ– MediaPipe
        async function initMediaPipe() {
            pose = new Pose({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`;
                }
            });

            pose.setOptions({
                modelComplexity: 1,
                smoothLandmarks: true,
                enableSegmentation: false,
                smoothSegmentation: false,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            pose.onResults(onResults);

            camera = new Camera(videoElement, {
                onFrame: async () => {
                    if (isDetecting) {
                        await pose.send({ image: videoElement });
                    }
                },
                width: 1280,
                height: 720
            });
        }

        // é–‹å§‹åµæ¸¬
        async function startDetection() {
            if (!isDetecting) {
                isDetecting = true;
                startBtn.textContent = 'åœæ­¢åµæ¸¬';
                statusText.textContent = 'åµæ¸¬ä¸­...';
                camera.start();
            } else {
                isDetecting = false;
                startBtn.textContent = 'é–‹å§‹åµæ¸¬';
                statusText.textContent = 'å·²åœæ­¢';
                camera.stop();
            }
        }

        // é‡ç½®çµ±è¨ˆ
        function resetStats() {
            stats = {
                totalTime: 0,
                correctTime: 0,
                incorrectTime: 0,
                lastUpdateTime: Date.now()
            };
            updateStats();
        }

        // äº‹ä»¶ç›£è½å™¨
        startBtn.addEventListener('click', startDetection);
        resetBtn.addEventListener('click', resetStats);

        // è¨­å®šé¢æ¿çš„äº‹ä»¶ç›£è½å™¨
        document.getElementById('shoulderSensitivity').addEventListener('input', (e) => {
            thresholds.shoulderAngle = parseInt(e.target.value);
            document.getElementById('shoulderValue').textContent = e.target.value + 'Â°';
        });

        document.getElementById('backMinSensitivity').addEventListener('input', (e) => {
            thresholds.backAngleMin = parseInt(e.target.value);
            document.getElementById('backMinValue').textContent = e.target.value + 'Â°';
        });

        document.getElementById('backMaxSensitivity').addEventListener('input', (e) => {
            thresholds.backAngleMax = parseInt(e.target.value);
            document.getElementById('backMaxValue').textContent = e.target.value + 'Â°';
        });

        document.getElementById('headSensitivity').addEventListener('input', (e) => {
            thresholds.headForward = parseInt(e.target.value) / 100;
            document.getElementById('headValue').textContent = e.target.value + '%';
        });

        document.getElementById('resetSettingsBtn').addEventListener('click', () => {
            // é‡ç½®ç‚ºé è¨­å€¼
            thresholds = {
                shoulderAngle: 15,
                backAngleMin: 60,
                backAngleMax: 120,
                headForward: 0.45
            };
            document.getElementById('shoulderSensitivity').value = 15;
            document.getElementById('shoulderValue').textContent = '15Â°';
            document.getElementById('backMinSensitivity').value = 60;
            document.getElementById('backMinValue').textContent = '60Â°';
            document.getElementById('backMaxSensitivity').value = 120;
            document.getElementById('backMaxValue').textContent = '120Â°';
            document.getElementById('headSensitivity').value = 45;
            document.getElementById('headValue').textContent = '45%';
        });

        // åˆå§‹åŒ–
        async function init() {
            statusText.textContent = 'æ­£åœ¨åˆå§‹åŒ–...';
            
            const cameraOk = await initCamera();
            if (!cameraOk) {
                alert('ç„¡æ³•å­˜å–æ”å½±æ©Ÿï¼Œè«‹ç¢ºèªå·²æˆäºˆæ¬Šé™');
                return;
            }

            await initMediaPipe();
            statusText.textContent = 'æº–å‚™å°±ç·’ï¼Œé»æ“Šé–‹å§‹åµæ¸¬';
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
